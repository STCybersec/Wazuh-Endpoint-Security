# export_vulnerabilities.ps1
# ---------------------------------------------------------
# Description:
#   Connects to the Wazuh API and exports all detected
#   vulnerabilities into a CSV report.
#
# Usage:
#   Run in PowerShell:
#       ./export_vulnerabilities.ps1
#
# Notes:
#   - Ensure API user has "read" permissions.
#   - Replace <WAZUH-MANAGER-IP> and credentials.
# ---------------------------------------------------------

# --- Configuration ---
$WazuhURL = "https://<WAZUH-MANAGER-IP>:55000"
$User = "wazuh"
$Pass = "yourpassword"
$OutFile = "vulnerabilities_export.csv"

# --- Build Headers ---
$pair = "$($User):$($Pass)"
$encodedCreds = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes($pair))
$Headers = @{
    Authorization = "Basic $encodedCreds"
}

# --- API Request ---
try {
    $response = Invoke-RestMethod `
        -Method Get `
        -Uri "$WazuhURL/vulnerability" `
        -Headers $Headers `
        -SkipCertificateCheck

    # --- Export ---
    $response.data.vulnerabilities | Export-Csv -NoTypeInformation -Path $OutFile

    Write-Host "✔ Vulnerabilities exported to $OutFile"

}
catch {
    Write-Host "❌ Error connecting to Wazuh API: $($_.Exception.Message)"
}
